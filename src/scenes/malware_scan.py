from scene import Scene
from screen import Screen

from pathlib import Path
import time
import random


class MalwareScan(Scene):

    # Folders saved at a time
    MAXIMUM_FOLDERS_SAVED = 1000

    # The time of execution in seconds (currently "minimum" is redundant)
    MINIMUM_EXECUTION_TIME = 5 * 60

    # The random number generator's start/end
    RANDOM_SUSPICIOUS_FLAG_GENERATION_START = 1
    RANDOM_SUSPICIOUS_FLAG_GENERATION_END = 1000

    # When this number is generated the file is considered "suspicious"
    RANDOM_SUSPICIOUS_FLAG = 557

    def scanFolder(self, rootpath: Path):
        dirs = [rootpath.absolute()]
        while dirs:
            directory = dirs.pop(0)
            try:
                for item in directory.iterdir():
                    item = item.absolute()
                    if item.is_symlink():
                        continue
                    elif item.is_dir():
                        if len(dirs) < self.MAXIMUM_FOLDERS_SAVED:
                            dirs.append(item)
                    else:
                        yield item
            except (PermissionError,FileNotFoundError):
                pass

    def run(self, screen: Screen):
        processing_handle = screen.processing(100, "Scanning files")
        start = time.time()
        for item in self.scanFolder(Path("/")):
            try:
                stats = item.stat()
                delta = stats.st_size / 1024 ** 2
                t = min(max(delta * 0.01, 0.01), 5)

                processing_handle.clear()
                screen.log(f"Scanning {item}...")
                processing_handle.refresh()
                time.sleep(t)

                suspicious = random.randint(self.RANDOM_SUSPICIOUS_FLAG_GENERATION_START,
                                            self.RANDOM_SUSPICIOUS_FLAG_GENERATION_END) == self.RANDOM_SUSPICIOUS_FLAG
                processing_handle.clear()
                if suspicious:
                    screen.error(item, "seems suspicious")
                else:
                    screen.success(item, "is safe")
            except (PermissionError, FileNotFoundError):
                pass
            execution_time = time.time() - start
            processing_handle.n = int((execution_time / self.MINIMUM_EXECUTION_TIME) * 100)
            processing_handle.update(0)
            processing_handle.refresh()
            if execution_time > self.MINIMUM_EXECUTION_TIME:
                break
        processing_handle.close()
