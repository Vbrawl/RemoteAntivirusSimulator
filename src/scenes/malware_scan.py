from scene import Scene
from screen import Screen

from pathlib import Path
import time
import random


class MalwareScan(Scene):

    # Folders saved at a time
    MAXIMUM_FOLDERS_SAVED = 1000

    # The time of execution in seconds
    EXECUTION_TIME = 5 * 60

    # The multiplier used on the size to determine the correct sleep duration
    # The size for the multiplication is in MB
    SCAN_MULTIPLIER = 0.01
    MINIMUM_SCAN_DURATION = 0.01
    MAXIMUM_SCAN_DURATION = 5

    # The random number generator's start/end
    RANDOM_SUSPICIOUS_FLAG_GENERATION_START = 1
    RANDOM_SUSPICIOUS_FLAG_GENERATION_END = 1000

    # When this number is generated the file is considered "suspicious"
    RANDOM_SUSPICIOUS_FLAG = 557

    def __init__(self, execution_time: int = EXECUTION_TIME,
                 scan_multiplier: int = SCAN_MULTIPLIER,
                 maximum_scan_duration: int = MAXIMUM_SCAN_DURATION,
                 minimum_scan_duration: int = MINIMUM_SCAN_DURATION):
        Scene.__init__(self)
        self.execution_time = execution_time
        self.scan_multiplier = scan_multiplier
        self.maximum_scan_duration = maximum_scan_duration
        self.minimum_scan_duration = minimum_scan_duration

    def scanFolder(self, rootpath: Path):
        dirs = [rootpath.absolute()]
        while dirs:
            directory = dirs.pop(0)
            try:
                for item in directory.iterdir():
                    item = item.absolute()
                    if item.is_symlink():
                        continue
                    elif item.is_dir():
                        if len(dirs) < self.MAXIMUM_FOLDERS_SAVED:
                            dirs.append(item)
                    else:
                        yield item
            except (PermissionError, FileNotFoundError):
                pass

    def scanFile(self, filepath: Path) -> bool:
        stats = filepath.stat()
        delta = stats.st_size / 1024 ** 2
        t = min(max(delta * self.scan_multiplier, self.minimum_scan_duration), self.maximum_scan_duration)
        time.sleep(t)

        return random.randint(self.RANDOM_SUSPICIOUS_FLAG_GENERATION_START,
                              self.RANDOM_SUSPICIOUS_FLAG_GENERATION_END) == self.RANDOM_SUSPICIOUS_FLAG

    def run(self, screen: Screen):
        # Initialize timers and progress bars
        processing_handle = screen.processing(100, "Scanning files")
        start = time.time()
        for item in self.scanFolder(Path("/")):
            try:
                # Scan file
                processing_handle.clear()
                screen.log(f"Scanning {item}...")
                processing_handle.refresh()

                suspicious = self.scanFile(item)

                processing_handle.clear()
                if suspicious:
                    screen.error(item, "seems suspicious")
                else:
                    screen.success(item, "is safe")
            except (PermissionError, FileNotFoundError):
                pass

            execution_time = time.time() - start
            processing_handle.n = int((execution_time / self.execution_time) * 100)
            processing_handle.update(0)
            processing_handle.refresh()
            if execution_time > self.execution_time:
                break
        processing_handle.close()
